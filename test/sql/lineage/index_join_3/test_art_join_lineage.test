# name: test/sql/index/join_lineage/test_index_join.test
# description: Test Joins using art indexes
# group: [index_join_3]


statement ok
PRAGMA explain_output = PHYSICAL_ONLY;
PRAGMA force_index_join

statement ok
CREATE TABLE t1(i INTEGER, j INTEGER);
CREATE TABLE t2(i INTEGER);
CREATE TABLE t3(i INTEGER);
CREATE INDEX i_index ON t1 using art(i);

statement ok
INSERT INTO t1 SELECT i+1, i FROM range(0,60) tbl(i);
INSERT INTO t2 SELECT i+1 FROM range(50,60) tbl(i);
INSERT INTO t3 SELECT i+3 FROM range(50,60) tbl(i);

statement ok
PRAGMA trace_lineage = "ON";

# standalone limit
query IIII
select t1.i, t1.j, t2.i, t3.i from t1 inner join t2 on (t1.i = t2.i)  inner join  t3 on (t3.i=t2.i)
----
53	52	53	53
54	53	54	54
55	54	55	55
56	55	56	56
57	56	57	57
58	57	58	58
59	58	59	59
60	59	60	60

statement ok
PRAGMA trace_lineage = "OFF";

query II
SELECT * FROM queries_list;
----
21	select t1.i, t1.j, t2.i, t3.i from t1 inner join t2 on (t1.i = t2.i)  inner join  t3 on (t3.i=t2.i)
23	PRAGMA trace_lineage = "OFF";

query IIII
select rowid, chunk_id, index, value from INDEX_JOIN_21_0_LHS;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	5
6	0	6	6
7	0	7	7

query IIII
select rowid, chunk_id, index, value from INDEX_JOIN_21_0_RHS;
----
0	0	0	52
1	0	1	53
2	0	2	54
3	0	3	55
4	0	4	56
5	0	5	57
6	0	6	58
7	0	7	59


query IIII
select rowid, chunk_id, index, value from HASH_JOIN_21_0_LHS;
----
0	0	0	2
1	0	1	3
2	0	2	4
3	0	3	5
4	0	4	6
5	0	5	7
6	0	6	8
7	0	7	9


query IIII
select r.rowid, r.chunk_id, s.index, r.index from HASH_JOIN_21_0_SINK as s, HASH_JOIN_21_0_RHS as r where s.value=r.value ;
----
0	0	0	0
1	0	1	1
2	0	2	2
3	0	3	3
4	0	4	4
5	0	5	5
6	0	6	6
7	0	7	7